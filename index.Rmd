---
title: "Computational Musicology Portfolio"
author: "Nina Verheijen"
date: "2021"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: flatly
---




```{r echo = FALSE, message=FALSE}
library(tidyverse)
library(dplyr)
library(spotifyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(plotly)
library(compmus)
library(Rmisc)
library(knitr)
library(tidymodels)
library(ggdendro)
library(heatmaply)
library(kableExtra)
```

```{r echo = FALSE}
all_data_rammstein <- get_playlist_audio_features("","4ubZwxPRbLmmaxwsrcoksY")

rammstein_paris <- get_playlist_audio_features("","4td6SJ4cvyFWgJn9I9EtnT")
rammstein_berlin <- get_playlist_audio_features("","1YWLnvtP4lgROQWB7HqZxT")

  

rammstein <- all_data_rammstein%>%
  select(c(36, 50, 6:16)) %>%
  mutate(
    track.album.release_date = lubridate::year(track.album.release_date)
  )

rammstein_2019 <- rammstein %>%
  filter(track.album.release_date == "2019")

rammstein_1995 <- rammstein %>%
  filter(track.album.release_date == "1995")
  
rammstein_live <- bind_rows(
  rammstein_paris %>% mutate(category = "live at paris"),
  rammstein_berlin %>% mutate(category = "live at berlin") 
  )%>%
  select(c(36, "category", 50, 6:16)) %>% 
  mutate(track.name = str_sub(track.name, 1,-8))

rammstein_not_live <- get_playlist_audio_features("","0A0m04BWQCIozwguPMaRzE") %>%
  select(c(36, 50, 6:16))

rammstein_not_live[29, "track.name"] = "Wilder Wein"

live_not_live <- bind_rows(
  rammstein_live,
  rammstein_not_live %>% mutate(category = "studio")
)

live_not_live <- live_not_live %>% mutate(
  track.name = tolower(track.name)
)

rammstein_sum <- rammstein%>%
  group_by(track.album.release_date)%>%
  summarise(
    mean_speechiness = mean(speechiness),
    mean_acousticness = mean(acousticness),
    mean_liveness = mean(liveness),
    mean_energy = mean(energy),
    mean_danceability = mean(danceability),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key = mean(key),
    mean_valence = mean(valence)
  )



```





```{r}
get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}  
```

```{r}
ramm <- 
  get_playlist_audio_features("","4zHoeSDpe1tLBOnWaTYuZs")
LIFAD <- 
  get_playlist_audio_features("", "5uJSCBbKMkJlFGhpIVAEKL")
rosenrot <- 
  get_playlist_audio_features("", "450ruWPhAMlGcgmTpELaJY")
reise <- 
  get_playlist_audio_features("", "1sw0say7N84xGnljIUvFxW")
mutter <- 
  get_playlist_audio_features("", "6I3LPUsJrAyFJX9M25ocM3")
sehnucht <- 
  get_playlist_audio_features("", "1hRBY4y59Tj6MNm5aW2AbH")
herzeleid <- 
  get_playlist_audio_features("", "6MPrZZiCfHOPWMFa5OjVhv")


all_not_live <-
  bind_rows(
    ramm %>% mutate(playlist = "RAMMSTEIN"),
    LIFAD %>% mutate(playlist = "LIEBE IST FÜR ALLE DA"),
    rosenrot %>% mutate(playlist = "ROSENROT"),
    reise %>% mutate(playlist = "REISE, REISE"),
    mutter %>% mutate(playlist = "Mutter"),
    sehnucht %>% mutate(playlist = "Sehnsucht"),
    herzeleid %>% mutate(playlist = "Herzeleid")
    
  ) 

```


```{r}
not_live_features <-
  all_not_live %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>% 
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

```

```{r}
not_live_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = not_live_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].
```


```{r}
not_live_cv <- not_live_features %>% vfold_cv(10)
```





```{r}
forest_model <-
  rand_forest() %>%
  set_mode("classification") %>% 
  set_engine("ranger", importance = "impurity")
not_live_forest <- 
  workflow() %>% 
  add_recipe(not_live_recipe) %>% 
  add_model(forest_model) %>% 
  fit_resamples(
    not_live_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```

### What **features** make albums stand out?

```{r}
not_live_forest %>% get_conf_mat() %>% autoplot(type = "heatmap") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ggtitle("Confusion matrix") + theme(plot.title = element_text(hjust = 0.5))
```

*** 
To see if some of the albums from Rammstein stand out, a **Random Forest classifier** was used to see how well the tracks can be linked to their album. The confusion matrix indicates that tracks form *Herzeleid (1995)*, *Sehnsucht (1997)* and *LIEBE IST FüR ALLE DA (2009)* are easier to classify than tracks from their other albums. This can also be seen in the accuracy score. __The albums *Herzeleid*, *LIEBE IST FüR ALLE DA* and *Sehnsucht* have higher precision and recall than the other albums.__  

```{r}
accuracy <- not_live_forest %>% get_pr()

kable(accuracy, col.names=c('Album', 'Precision', 'Recall'), align='lrr', "pipe")
```
Another album that stands out is *ROSENROT (2005)*, since it has zero precision and recall. This is not that surprising, where albums like *Herzeleid* and *Sehnsucht* have tracks which sound somewhat similar, the tracks from *ROSENROT* do not have much in common which makes it difficult to classify.



### What features distinguish albums?

```{r}
workflow() %>% 
  add_recipe(not_live_recipe) %>% 
  add_model(forest_model) %>% 
  fit(not_live_features) %>% 
  pluck("fit", "fit", "fit") %>%
  ranger::importance() %>% 
  enframe() %>% 
  mutate(name = fct_reorder(name, value)) %>% 
  ggplot(aes(name, value)) + 
  geom_col() + 
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")+
  ggtitle("Features ranked on importance") + 
  theme(plot.title = element_text(hjust = 0.5))
```

***
To see which features are the most important. The features are ranked on importance using Random Forest. The graph indicates that the **c12 timbre component**, **loudness** and the **c02 timbre component** are the most important.



### What makes some albums more recognizable than others?

```{r echo=FALSE, warning=FALSE}
not_live_features %>%
  ggplot(aes(x = c12, y = c02, colour = playlist, size = loudness, label=track.name)) +
  geom_point(alpha = 0.8) + 
  scale_colour_manual(values = c("red","yellow", "orange","pink", "purple", "blue", "green")) +
  geom_text(                  # Add text labels from above.
    aes(
      x = c12,
      y = c02,
      label = label
    ),
    data = 
      tibble(
        label = c("EIN LIED", "DIAMANT", "ROTER SAND", "FRÜHLING IN PARIS"),
        category = c("ROSENROT", "RAMMSTEIN", "LIEBE IST FüR ALLE DA", "LIEBE IST FüR ALLE DA"),
        c12 = c(3.8, 3.9, 12.8, 12.5),
        c02 = c(-66.1,-43.8, -10.1, 29.09)
      ),
    colour = "black",         # Override colour (not mode here).
    size = 2.5,                 # Override size (not loudness here).
    hjust = "right",           # Align left side of label with the point.
    vjust = "bottom",         # Align bottom of label with the point.
    nudge_x = -0.1,          # Nudge the label slightly left.
    nudge_y = 4            # Nudge the label slightly up.
  )+
  labs(
    x = "Timbre Component 12",
    y = "Timbre Component 2",
    size = "loudness",
    colour = "Album"
  )


```

***

The feature set mentioned in the last tab is used to see if a better plot can be made. It looks like *Herzeleid* and *Sehnsucht* both have a **higher timbre component 2** than the other albums. 

*LIEBE IST FüR ALLE DA* is **higher on component 12**, especially the tracks *FRÜHLING IN PARIS* and *ROTER SAND*. That would explain why those albums can be better classified. 

It also shows that *EIN LIED* and *DIAMANT* have a **very low component 2** which might explain why their albums *ROsENROT* and *RAMMSTEIN* are more difficult to classify. 

It is interesting that **loudness** is mentioned as one of the most important features since in this graphs there is not much difference in loudness, except for *EIN LIED*.

### Introduction

Starting in Berlin in 1994, Rammstein has been around for almost 30 years. With their first album *Herzeleid* released in September 1995, and their latest album *Rammstein* in May 2019, a lot has changed in the music industry since they first started. This raises the question whether their music has changed as well, and if so, how?

To answer this question, a corpus is used which consists of  the seven studio albums from Rammstein (77 tracks);

* *Herzeleid* (1995)
* *Sehnsucht* (1997)
* *Mutter* (2001)
* *Reise, Reise* (2004)
* *Rosenrot* (2005)
* *Liebe ist für alle da* (2009)
* *Rammstein* (2019)

In addition to this two live albums were also included (27 tracks);

* *Live aus Berlin* (1999)
* *Rammstein: Paris* (2017)

The studio albums were included to see if their music changed over time and if so how? What changed? What did not change through all those years? Are there similarities between albums?
The studio albums are added because it might also be interesting to look at differneces between live and studio albums.

The comparison points in this corpus are between the different studio albums, between the live albums and their corresponding studio tracks and between the live albums.

The corpus is quite representative as there are plenty of albums, and thus tracks, to compare. However, when looking at changes in albums over time, it has to be noted that 6 of the 7 studio albums were released in a 14 year time period (1995-2009), and in the last 12 years only one album has been released.

A few tracks that are atypical are *Diamant* (*Rammstein*, 2019), *Roter Sand* (*Liebe ist für alle da*, 2009), *Los* (*Reise, Reise*, 2004) and *Ein Lied* (*Rosenrot*, 2005). *Diamant* and *Roter Sand* have sound a lot more like ballads than the industrial metal we're used from Rammstein. *Los* and *Ein Lied* both have a more slow, easy going tempo and have less distortion than other songs in the corpus.




### What changed between the first and last album from Rammstein?


```{r echo = FALSE}

rammstein_first_last <- bind_rows(rammstein_1995, rammstein_2019)

rammstein_f_l_val <- ggplot(rammstein_first_last, aes(valence, danceability, color=factor(track.album.release_date), size=instrumentalness, label=track.name))+
  geom_point() +
  theme(legend.title = element_blank())

ggplotly(rammstein_f_l_val)%>%
  layout(legend = list(
      orientation = "v",
      x = "auto",
      font = list(
        family = "sans-serif",
        size = 15,
        color = "#000"),
      bgcolor = "#E2E2E2",
      bordercolor = "#FFFFFF",
      borderwidth = 2,
      title=list(text="Instrumentalness")
    )
  )

```



***

When comparing the first and last album, the first one released in 1995 and the last one released in 2019, a few things have changed when looking at spotify features.


The features with the most change are danceability, valence and instrumentalness. The danceability, valence and instrumentalness are all lower in the last album than in the first album. 

### Rammstein's albums over time.

```{r echo=FALSE}
rammstein_dance_val <- ggplot(rammstein, aes(track.album.release_date, danceability, size=valence, color=instrumentalness, label=track.name)) +
  geom_point(alpha = 0.5)+
  labs(x="album release year")
 

rammstein_dance_val
```

***

To see if this was also the case when looking at all albums, the valence, danceability and instrumentalness were plotted for each album. It is clear that the danceability decreases over time, and with that the valence and instrumentalness as well.

The last album has the most variation in danceablity and valence. However, the instrumentalness stays quit the same for most tracks in the last album.



### Changes in tempo between first and last album.


```{r}
first <-
  get_playlist_audio_features(
    "",
    "6MPrZZiCfHOPWMFa5OjVhv"
  ) %>%
  slice(1:30) %>%
  add_audio_analysis()
last <-
  get_playlist_audio_features(
    "",
    "4zHoeSDpe1tLBOnWaTYuZs"
  ) %>%
  slice(1:30) %>%
  add_audio_analysis()
```

```{r}
first_and_last <-
  first %>%
  mutate(genre = "Herzeleid (1995)") %>%
  bind_rows(last %>% mutate(genre = "Rammstein (2019)")) %>%
  mutate(
    sections =
      map(
        sections,                                    # sections or segments
        summarise_at,
        vars(tempo, loudness, duration),             # features of interest
        list(section_mean = mean, section_sd = sd)   # aggregation functions
      )
  ) %>%
  unnest(sections)


test <-
  ggplot(first_and_last,
    aes(
      x = tempo,
      y = tempo_section_sd,
      colour = genre,
      label = track.name
    )
  ) +
  geom_point(size=4, alpha=0.6) +
  geom_rug() +
  theme_minimal() +
  ylim(0, 5) +
  labs(
    x = "Mean Tempo (bpm)",
    y = "SD Tempo",
    colour = "Genre"
  )  

ggplotly(test) %>%
  layout(legend = list(
      orientation = "v",
      x = "auto",
      font = list(
        family = "sans-serif",
        size = 15,
        color = "#000"),
      bgcolor = "#E2E2E2",
      bordercolor = "#FFFFFF",
      borderwidth = 2,
      title=list(text="Album")
    )
  )
```

***
This graph shows the **standard deviation** and the **mean** of the tempo of the tracks of the first album (*Herzeleid*, 1995) and last album (*Rammstein*, 2019). A clear difference can be seen between the first and last album. **The standard deviation of the tempo of the last album is generally higher than the standard deviation of the tempo of the first album.** Furthermore, **the mean tempo of the last album is also higher than the first album,** which is interesting since the danceability of the last album is lower than the first album.


### Tempograms


```{r out.width = "100%"}
temp_path <- "tempo.png"

include_graphics(temp_path)
```



***

The graph in the tab about changes in tempo between the first and last album indicates that [*Weit weg*](https://open.spotify.com/track/0sMmtnF7by7WPNeRXCam9H?si=_KUDF8oETGaTsCY6k70F2A) has a mean tempo of 202 bpm. Which is surprising since the track is actually not that fast in tempo.To get a better understanding of why Spotify gave it such a high mean tempo, the tempogram of the track is plotted. The left tempogram is the same tempogram as on the right but wrapped into a cyclic tempogram to see more details.

For the first twenty seconds a yellow line can be seen at around 160 bpm in both tempograms. After twenty seconds a yellow line can be seen on the left graph at around 150 bpm while at the right graph the yellow line is at around 250 bpm. In the left graph a vague line can be seen at around 100 bpm which is closer to the actual tempo of the track. Spotify might pick up the somewhat fast drum in the background and based on that give this track such a high mean tempo. Especially since this rhythm is repeated multiple times through the track.


### Comparing live tracks to studio tracks.


```{r echo=FALSE}

rammstein_live_not_live <- ggplot(live_not_live, aes(valence, energy, size=liveness, color=category, label=track.name)) +
  geom_point(alpha=0.6) + 
  geom_path(aes(group=track.name), size = 0.05, color="black")+
  theme(legend.title = element_blank())



ggplotly(rammstein_live_not_live)%>%
  layout(legend = list(
      orientation = "v",
      x = "auto",
      itemizing = "trace",
      font = list(
        family = "sans-serif",
        size = 15,
        color = "#000"),
      bgcolor = "#E2E2E2",
      bordercolor = "#FFFFFF",
      borderwidth = 2
    )
  ) %>%
  layout(legend=list(title=list(text=' Liveness')))
```

*** 
When comparing the live tracks, both from Berlin (1999) and from Paris (2017), to the studio tracks it is clear that the studio tracks have a higher valence and more danceability.

Different versions of the tracks are connected with lines. Which show that there is definitely some difference between the two live albums and between the live and studio tracks. One obvious difference is that the live tracks have a higher liveness than the studio track. The live album from Berlin seems to have a higher valence than the live album from Paris, which might be explained by the fact that the older albums also have a higher valence than the newer albums. When comparing the live tracks to their corresponding studio track, almost all studio tracks have a higher valence



### Comparing two live versions of *Du hast*, one of the most iconic songs of Rammstein.

```{r}
Du_hast_berlin <-
  get_tidy_audio_analysis("7c6jrUp0VsgLXhlzP4QZSy") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)



Du_hast_paris <-
  get_tidy_audio_analysis("0qrwXiw0o8aoXHbaqSAAzz") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)


compmus_long_distance(
  Du_hast_berlin %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  Du_hast_paris %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  feature = pitches,
  method = "angular"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Du hast live Berlin (1999)", y = "Du hast live Paris (2017)") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)
```

***
When comparing a track that was played live in 1999 and in 2017 a small diagonal line can be seen in the middle, which indicates that the tracks are indeed somewhat similar.


### Why is *Diamant* so different from their other songs?


#### Diamant

```{r}
diamant <-
  get_tidy_audio_analysis("1UZs9dauJnxrqYxMIzxnwC") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  diamant %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  diamant %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```




#### Du hast

```{r echo = FALSE}
du_hast <-
  get_tidy_audio_analysis("5awDvzxWfd53SSrsRZ8pXO") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  du_hast %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  du_hast %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```


#### Link 2 3 4

```{r echo = FALSE}
links <-
  get_tidy_audio_analysis("52XYwQKlXp7scE7KrBBCID") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  links %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  links %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```


As mentioned before, *diamant* is a very atypical song from Rammstein since it sound much more like a full on ballad than a heavy metal song. To see how this song differs from a more typical Rammstein song like *Du hast* or *Links 2 3 4 *, the chroma-based and timbre-based self-similarity matrices for these songs are shown. What stands out is that *Du hast* and *Links 2 3 4* have a much more clear structure and when listening to the songs the patterns are very recognizable. *Diamant* on the other hand has a much more complex structure and when listening to the song it is hard to recognize the patterns from the matrix.

When looking at the timbre based self-similarity matrices, *Du hast* and *Links 2 3 4* have more dark blocks, meaning more homogeneity within the timeframes. Whereas *Diamant* has more vertical yellow lines, indicating more novelties. Besides that, *Diamant* also has a lot of diagonal lines in the chroma based matrix and only a vaguely visible checkerboard pattern, which indicates that a melodic phrase or passage is repeated in different parts of the song. It starts of with just guitar and voice and adds more and more strings as the song progresses. The other two tracks both start with an intro, but after that only have a few vertical lines, thus only a few novelties.





```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```


### Chordogram

```{r}
los <- get_tidy_audio_analysis("6IUhPMJf4iJQ3Go1CkHDsa") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  ) %>% 
  compmus_match_pitch_template(chord_templates, "euclidean", "manhattan") %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")


reise <- get_tidy_audio_analysis("6bvTzuFABmFnAAmVZ3nlMh") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  ) %>% 
  compmus_match_pitch_template(chord_templates, "euclidean", "manhattan") %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")


grid.arrange(los, reise, ncol=2)

```

***

Comparison of an atypical track (*Los*) to a more typical track (*Reise, Reise*) from Rammstein, both from the album *Reise Reise*. Even though the songs are very different, some similarities can be found in their chordograms. Both show darker lines for the C:7, Eb:7 and Ab;7, and lighter lines around D:min and Bb:maj.



### Conclusion
to do













